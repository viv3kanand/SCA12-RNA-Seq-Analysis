---
title: "Figures"
author: "viv3kanand"
date: "2023-05-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load packages
```{r}
require(ggplot2)
require(ggrepel)
require(ggplotify)
require(cowplot)
require(tidyverse)
require(paletteer)
require(broom)
```

### Load datasets
```{r}
source("../scripts/helper_scripts.R")

se <- readRDS("RData/se.rds")
gse <- readRDS("RData/gse.rds")
se_out <- readRDS("RData/se_out.rds")
gse_out <- readRDS("RData/gse_out.rds")
dds <- readRDS("RData/dds.rds")
vst_mat <- readRDS("RData/vst_bc.rds")
```

### Custom theme to apply
```{r}
# Theme elements
font <- "Helvetica"
text_size <- 10
line_size <- 0.5

# Figure elements
res <- 300
full_width <- 8.5
full_height <- 13
meas_units <- "in"
output_filetype <- "svg"
fig_lab_size <- 9
fig_lab_pos_x <- 0
fig_lab_pos_y <- 1
label_type <- "AUTO"

custom_theme <- function(){
  theme_classic() +
    theme(text = element_text(family = font,
                              size = text_size),
          line = element_line(linewidth = line_size),
          axis.title = element_text(size = rel(1.25)),
          axis.text = element_text(size = rel(1.15)),
          plot.title = element_text(size = rel(1.5),
                                    hjust = 0.5),
          panel.grid = element_blank(),
          plot.background = element_rect(fill = "white"),
          legend.position = "right",
          legend.text=element_text(size=text_size))
}




palette1 <- c("#E64B35FF", "#417839FF")
palette2 <- c("#FF3D7FFF", "#3FB8AFFF")
palette3 <- c("#3A488AFF", "#BE3428FF") # paletteer_d("lisa::OskarSchlemmer")
palette4 <- c("#CF597EFF", "#009392FF") # paletteer_d("rcartocolor::Temps")
palette5 <- c("#CF597EFF",  "#D6D6D6FF", "#009392FF")

```


### PCA of Batch effect corrected and uncorrected samples
```{r}
li <- list("Uncorrected" = dds, "Corrected" = vst_mat)

coldata <- colData(dds) %>% as.data.frame()

plot_list <- list()

# PCA plot
plot_list[["pca"]] <- purrr::imap(li, function(obj, name) {
  pca_result <- call_PCA(obj)
  p <- pca_result$pca %>% 
    augment(coldata) %>%
    ggplot(aes(x=.fittedPC1, y=.fittedPC2, color=Condition, shape = Cell_line)) + 
    geom_point(size = 3) + 
    geom_text(aes(label = Batch), hjust=0, vjust=0) +
    ggtitle(name) +
    xlab(paste0("PC1: ",round(pca_result$percentVar[1] * 100),"% variance")) +
    ylab(paste0("PC2: ",round(pca_result$percentVar[2] * 100),"% variance")) +
    coord_fixed() +
    labs(shape="Cell line", colour="Condition") +
    scale_color_manual(name = "Condition", values = palette4) +
    custom_theme()

  return(p)
})


# Scree plot
plot_list[["scree"]] <- purrr::imap(li, function(obj, name) {
  pca_result <- call_PCA(obj)
  p <- data.frame(Components = paste0("PC",seq_len(5)), 
           value = pca_result$percentVar[1:5]) %>%
    ggplot(aes(x = Components, y = value)) + 
    geom_col(fill = "#009392FF", width = 0.5) + 
    ggtitle(name) +
    ylab("% of total variance") + 
    scale_y_continuous(labels = scales::percent_format(),
                       expand = expansion(mult = c(0, 0.01))) +
    custom_theme()
  
  return(p)
})

row1 <- cowplot::plot_grid(plot_list$pca$Uncorrected + theme(legend.position="none"), 
                           plot_list$pca$Corrected + theme(legend.position="none"),
                           align = "hv")

legend1 <- get_legend(
  plot_list$pca$Uncorrected + theme(legend.box.margin = margin(0, 0, 0, 12))
)

plot_pca <- plot_grid(row1, legend1, rel_widths = c(2, .4))

```

### Heatmap Neuron
```{r}
plot_list[["heatmap"]] <- purrr::imap(gse_out, function(obj, name) {
  # Subset samples for plotting
  gene_list <- obj[["res"]] %>% 
    filter(abs(log2FoldChange) > 2 & padj < 0.01) %>% 
    pull("ID")
  
  mat <- obj[["vst"]][rownames(obj[["vst"]]) %in% gene_list,]
  
  meta <- colData(obj$dds) %>% as.data.frame() %>% select(Condition)
  
  # Plot functions
  # color_mapping <- colorRampPalette(c("#009392FF", "#CF597EFF"))(length(unique(meta$Condition)))
  # names(color_mapping) <- unique(meta$Condition)
  # 
  # ha = HeatmapAnnotation(
  #   Condition = anno_block(gp = gpar(fill = c("#009392FF", "#CF597EFF")),
  #   labels = c("Control", "Patient"),
  #   labels_gp = gpar(col = "white", fontsize = 10))
  # )
  
  ha <- HeatmapAnnotation(df = meta, 
                          col = list(
                            Condition = c("Control" = "#009392FF", "Diseased" = "#CF597EFF")))
  
  col_fun = paletteer_d("rcartocolor::Temps")
  
  
  # Plot heatmap
  h <- as.ggplot(Heatmap(t(scale(t(mat))), 
                         top_annotation = ha,
                         col = col_fun,
                         column_title = name,
                         column_km = 2,
                         row_km = 2, 
                         show_row_names = FALSE,
                         show_column_names = FALSE,
                         width = unit(10, "cm"),
                         rect_gp = gpar(col = "white", lwd = 0.1),
                         name = "Scaled\nnormalized\nexpression"))
  
  return(h)
  })

plot_heatmap <- cowplot::plot_grid(plot_list$heatmap$iPSC,
                                   plot_list$heatmap$NSC,
                                   plot_list$heatmap$Neuron,
                                   align = "hv",
                                   nrow = 1)
```


### Volcano plot
```{r}


gse_out$iPSC$res %>%
    mutate(Expression = case_when(
        log2FoldChange >= 2 & padj <= 0.01 ~ "Upregulated",
        log2FoldChange <= -2 & padj <= 0.01 ~ "Downregulated",
        TRUE ~ "Not significant")) %>% 
  ggplot(aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(aes(color = Expression)) +
  ggtitle("iPSC") +
  ggrepel::geom_text_repel(data = head(gse_out$iPSC$res[order(gse_out$iPSC$res$padj),], 10),
                            aes(label = ID)) +
  scale_color_manual(values = palette5) +
  scale_x_continuous(name = "Log2 fold change") +
  scale_y_continuous(name = "-Log10 padj") +
  geom_hline(yintercept = 2, linetype = 2, color = "black") +
  geom_vline(xintercept = c(-2, 2), linetype = 2, color = "black") +
  custom_theme()
```


### Save figures
```{r}
ggsave(plot = plot_pca,
       filename = "plots/PCA.png",
       bg = "white",
       width = full_width,
       height = full_height/2.5,
       units = meas_units,
       dpi = res)

ggsave(plot = plot_heatmap,
       filename = "plots/Heatmap.png",
       bg = "white",
       width = 20,
       height = 10,
       units = meas_units,
       dpi = res)
```











